<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Финансовые советы</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .statement-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container p-4">
    <h1>Финансовые советы</h1>
    <p>Выберите две загруженные выписки для анализа и получения советов:</p>
    <div class="statement-list border rounded p-2 mb-3"></div>
    <button id="compareBtn" class="btn btn-primary" disabled>Сравнить выбранные</button>
    <div id="advice" class="mt-4"></div>
    <a href="welcome.html" class="btn btn-secondary mt-4">На главную</a>
  </div>

  <script>
    const statementListDiv = document.querySelector('.statement-list');
    const compareBtn = document.getElementById('compareBtn');
    const adviceDiv = document.getElementById('advice');
    let selectedIds = [];

    function loadStatements() {
      const data = JSON.parse(localStorage.getItem('statements') || '[]');
      statementListDiv.innerHTML = '';

      if (data.length === 0) {
        statementListDiv.innerHTML = '<p>Выписки не загружены.</p>';
        compareBtn.disabled = true;
        return;
      }

      data.forEach(entry => {
        const label = document.createElement('label');
        label.className = 'd-block';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = entry.id;
        checkbox.className = 'me-2';

        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            if (selectedIds.length < 2) {
              selectedIds.push(checkbox.value);
            } else {
              checkbox.checked = false;
              alert('Можно выбрать только две выписки для сравнения.');
            }
          } else {
            selectedIds = selectedIds.filter(id => id !== checkbox.value);
          }
          compareBtn.disabled = selectedIds.length !== 2;
        });

        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(`Выписка от ${entry.dateUploaded} (${entry.transactions.length} транзакций)`));
        statementListDiv.appendChild(label);
      });
    }

    function parseAmount(str) {
      return parseFloat(str.replace(/[^\d.,\-]/g, '').replace(',', '.'));
    }

    function sumInOut(transactions) {
      let income = 0, expenses = 0;
      transactions.forEach(t => {
        const val = parseAmount(t.operationAmount);
        if (val > 0) income += val;
        else expenses += Math.abs(val);
      });
      return { income, expenses };
    }

    function analyze(prev, curr) {
      const prevSum = sumInOut(prev);
      const currSum = sumInOut(curr);
      const advice = [];

      if (currSum.income > prevSum.income) {
        advice.push(`Доходы выросли на ${(currSum.income - prevSum.income).toFixed(2)} ₽. Хорошая работа!`);
      } else if (currSum.income < prevSum.income) {
        advice.push(`Доходы снизились на ${(prevSum.income - currSum.income).toFixed(2)} ₽. Постарайтесь увеличить доходы.`);
      } else {
        advice.push('Доходы остались на прежнем уровне.');
      }

      if (currSum.expenses > prevSum.expenses) {
        advice.push(`Расходы выросли на ${(currSum.expenses - prevSum.expenses).toFixed(2)} ₽. Проверьте, можно ли их сократить.`);
      } else if (currSum.expenses < prevSum.expenses) {
        advice.push(`Расходы снизились на ${(prevSum.expenses - currSum.expenses).toFixed(2)} ₽. Это положительный знак!`);
      } else {
        advice.push('Расходы остались на прежнем уровне.');
      }

      return advice;
    }

    compareBtn.addEventListener('click', () => {
      const data = JSON.parse(localStorage.getItem('statements') || '[]');
      const first = data.find(d => d.id === selectedIds[0]);
      const second = data.find(d => d.id === selectedIds[1]);

      if (!first || !second) {
        adviceDiv.textContent = 'Ошибка загрузки выписок для сравнения.';
        return;
      }

      const advices = analyze(first.transactions, second.transactions);

      adviceDiv.innerHTML = '<h3>Советы по финансам:</h3>' + advices.map(a => `<p>${a}</p>`).join('');
    });

    loadStatements();
  </script>
</body>
