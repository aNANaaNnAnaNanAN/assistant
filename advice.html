<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Финансовые советы с категориями</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .statement-list {
      max-height: 320px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }
    table th, table td {
      text-align: center;
      vertical-align: middle;
    }
    table td.category-name {
      text-align: left;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1>Финансовые советы</h1>
    <p>Выберите две загруженные выписки для анализа и получения советов:</p>

    <div class="statement-list border rounded p-3"></div>

    <button id="compareBtn" class="btn btn-primary" disabled>Сравнить выбранные</button>
    <div id="advice" class="mt-4"></div>
    <div id="comparisonTable" class="mt-4"></div>

    <a class='btn btn-secondary mt-4' href='/index.html'>На главную</a>
  </div>

<script>
const statementListDiv = document.querySelector('.statement-list');
const compareBtn = document.getElementById('compareBtn');
const adviceDiv = document.getElementById('advice');
const comparisonTableDiv = document.getElementById('comparisonTable');
let selectedIds = [];

const categoriesMap = {
  "Прочие расходы": ["прочие расходы", "прочие операции", "все для дома", "miscellaneous expenses", "miscellaneous operations", "home", "prochie", "doma"],
  "Коммунальные услуги": ["коммунальные услуги", "связь", "интернет", "internet", "communication", "utilities", "kommunal", "svyaz", "телефон", "mobile", "tele2", "mts", "beeline"],
  "Переводы с карты": ["внутренний перевод на договор","перевод с карты", "card transfer", "internal transfer", "perevod s karty", "vnutrenniy", "с карты"],
  "Перевод на карту": ["внутрибанковский перевод с договора","перевод на карту", "transfer to card", "intrabank transfer", "perevod na kartu", "на карту"],
  "Здоровье и красота": [
    "здоровье", "аптека", "apteka", "pharmacy", "cosmetics", "beauty", "косметология",
    "zdravookhranenie", "kosmetologiya", "vita", "samson-pharma", "gorzdrav", "366", "eapteka", "farm", "руэ", "аптека", "beaut", "санкт-петербург", "косметик"
  ],
  "Оплата товаров и услуг": [
    "магазин", "magazin", "онлайн игры", "online games", "игра", "игры", "odezhda", "обувь", "muz", "art shop",
    "shop", "goods", "services", "clothes", "shoes", "market", "lenta", "ozon", "wildberries", "wb", "mvideo", "dns", "lifestyle", "tvoi dom", "fixed price", "fix-price", "fixprice",
    "product", "pyaterochka", "пятерочка", "перекресток", "ashan", "ikea", "okey", "auchan", "yandex"
  ],
  "Транспорт": [
    "заправка", "апз", "benzin", "бензин", "автобус", "bus", "транспорт", "transport", "metro", "proezd",
    "taxi", "яндекс такси", "yandex taxi", "fuel", "убер", "proezdnoy", "aeroexpress", "moek", "moovit", "parking"
  ]
};

function categorizeTransaction(description) {
  const desc = description ? description.toLowerCase() : '';
  for (const [category, keywords] of Object.entries(categoriesMap)) {
    if (keywords.some(word => desc.includes(word))) {
      return category;
    }
  }
  return "Без категории";
}

function loadStatements() {
  const data = JSON.parse(localStorage.getItem('statements') || '[]');
  statementListDiv.innerHTML = '';
  if(data.length === 0){
    statementListDiv.innerHTML = '<p>Выписки не загружены.</p>';
    compareBtn.disabled = true;
    return;
  }
  data.forEach((entry, index) => {
    const label = document.createElement('label');
    label.className = 'd-block mb-2';
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.value = entry.id;
    checkbox.className = 'me-2';
    checkbox.addEventListener('change', () => {
      if(checkbox.checked){
        if(selectedIds.length < 2){
          selectedIds.push(checkbox.value);
        } else {
          checkbox.checked = false;
          alert('Можно выбрать только две выписки для сравнения.');
        }
      } else {
        selectedIds = selectedIds.filter(id => id !== checkbox.value);
      }
      compareBtn.disabled = selectedIds.length !== 2;
    });

    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Удалить';
    deleteBtn.className = 'btn btn-danger btn-sm ms-2';
    deleteBtn.onclick = () => {
      if (confirm('Вы действительно хотите удалить эту выписку?')) {
        const updatedData = JSON.parse(localStorage.getItem('statements') || '[]');
        updatedData.splice(index, 1);
        localStorage.setItem('statements', JSON.stringify(updatedData));
        selectedIds = selectedIds.filter(id => id !== entry.id);
        compareBtn.disabled = selectedIds.length !== 2;
        loadStatements();
        adviceDiv.innerHTML = '';
        comparisonTableDiv.innerHTML = '';
      }
    };

    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(`Выписка от ${entry.dateUploaded} (${entry.transactions.length} транзакций)`));
    label.appendChild(deleteBtn);
    statementListDiv.appendChild(label);
  });
}

function parseAmount(str) {
  return parseFloat(str.replace(/[^\d.,\-]/g,'').replace(',', '.')) || 0;
}

function groupByCategory(transactions) {
  const map = {};
  transactions.forEach(t => {
    const cat = t.category || categorizeTransaction(t.description || "");
    const amount = parseAmount(t.operationAmount || t.amount || 0);
    map[cat] = (map[cat] || 0) + amount;
  });
  return map;
}

function totalIncome(transactions) {
  return transactions.reduce((sum, t) => {
    const val = parseAmount(t.operationAmount || t.amount || 0);
    return val > 0 ? sum + val : sum;
  }, 0);
}

function totalOut(transactions) {
  return transactions.reduce((sum, t) => {
    const val = parseAmount(t.operationAmount || t.amount || 0);
    return val < 0 ? sum + Math.abs(val) : sum;
  }, 0);
}

function analyze(prev, curr) {
  prev.forEach(t => t.category = categorizeTransaction(t.description));
  curr.forEach(t => t.category = categorizeTransaction(t.description));
  const prevGrouped = groupByCategory(prev);
  const currGrouped = groupByCategory(curr);
  const allCats = Array.from(new Set([...Object.keys(prevGrouped), ...Object.keys(currGrouped)])).sort();
  const advice = [];
  allCats.forEach(cat => {
    const prevSum = prevGrouped[cat] || 0;
    const currSum = currGrouped[cat] || 0;
    if(currSum > prevSum){
      advice.push(`Расходы в категории "${cat}" выросли на ${(currSum - prevSum).toFixed(2)} ₽.`);
    } else if(currSum < prevSum){
      advice.push(`Расходы в категории "${cat}" снизились на ${(prevSum - currSum).toFixed(2)} ₽.`);
    } else {
      advice.push(`В категории "${cat}" расходы остались на прежнем уровне.`);
    }
    if(prevSum === 0 && currSum === 0){
      advice.pop();
    } else if(prevSum === 0){
      advice.push(`В этом месяце не было трат категории "${cat}".`);
    }
  });
  return advice.length ? advice : ['Нет изменений в расходах по категориям.'];
}

function renderComparisonTable(firstData, secondData, firstLabel, secondLabel) {
  const prevGrouped = groupByCategory(firstData);
  const currGrouped = groupByCategory(secondData);
  const allCats = Array.from(new Set([...Object.keys(prevGrouped), ...Object.keys(currGrouped)])).sort();

  const totalPrevIn = totalIncome(firstData);
  const totalPrevOut = totalOut(firstData);
  const totalCurrIn = totalIncome(secondData);
  const totalCurrOut = totalOut(secondData);

  const table = document.createElement('table');
  table.className = 'table table-bordered mt-3';

  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  headerRow.innerHTML = `
    <th>Категория</th>
    <th>${firstLabel}</th>
    <th>${secondLabel}</th>
  `;
  thead.appendChild(headerRow);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  allCats.forEach(cat => {
    const prevVal = prevGrouped[cat] || 0;
    const currVal = currGrouped[cat] || 0;
    const prevDisp = prevVal === 0 ? 'Нет трат' : prevVal.toFixed(2);
    const currDisp = currVal === 0 ? 'Нет трат' : currVal.toFixed(2);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="category-name">${cat}</td>
      <td>${prevDisp}</td>
      <td>${currDisp}</td>
    `;
    tbody.appendChild(tr);
  });

  const totalIncomeRow = document.createElement('tr');
  totalIncomeRow.innerHTML = `
    <td><b>Итого доходы</b></td>
    <td><b>${totalPrevIn.toFixed(2)}</b></td>
    <td><b>${totalCurrIn.toFixed(2)}</b></td>
  `;
  tbody.appendChild(totalIncomeRow);

  const totalOutRow = document.createElement('tr');
  totalOutRow.innerHTML = `
    <td><b>Итого расходы</b></td>
    <td><b>${totalPrevOut.toFixed(2)}</b></td>
    <td><b>${totalCurrOut.toFixed(2)}</b></td>
  `;
  tbody.appendChild(totalOutRow);

  table.appendChild(tbody);
  comparisonTableDiv.innerHTML = '';
  comparisonTableDiv.appendChild(table);
}

compareBtn.addEventListener('click', () => {
  const data = JSON.parse(localStorage.getItem('statements') || '[]');
  const first = data.find(d => d.id === selectedIds[0]);
  const second = data.find(d => d.id === selectedIds[1]);
  if (!first || !second) {
    adviceDiv.textContent = 'Ошибка загрузки выписок для сравнения.';
    comparisonTableDiv.innerHTML = '';
    return;
  }
  const advices = analyze(first.transactions, second.transactions);
  adviceDiv.innerHTML = '<h3>Советы по финансам:</h3>' + advices.map(a => `<p>${a}</p>`).join('');
  renderComparisonTable(first.transactions, second.transactions, `Выписка от ${first.dateUploaded}`, `Выписка от ${second.dateUploaded}`);
});

loadStatements();
</script>
</body>
</html>
